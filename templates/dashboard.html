<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Telegram Message Forwarder</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <style>
        body {
            padding-top: 2rem;
        }
        .logo {
            max-width: 50px;
            margin-bottom: 0.5rem;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .progress {
            height: 25px;
        }
        .progress-label {
            position: absolute;
            width: 100%;
            color: white;
            font-weight: bold;
            text-align: center;
            line-height: 25px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="/dashboard">
                    <svg class="logo me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="32" height="32">
                        <defs>
                            <linearGradient id="a" x1=".667" x2=".417" y1=".167" y2=".75">
                                <stop offset="0" stop-color="#37aee2"/>
                                <stop offset="1" stop-color="#1e96c8"/>
                            </linearGradient>
                            <linearGradient id="b" x1=".66" x2=".851" y1=".437" y2=".802">
                                <stop offset="0" stop-color="#eff7fc"/>
                                <stop offset="1" stop-color="#fff"/>
                            </linearGradient>
                        </defs>
                        <circle cx="120" cy="120" r="120" fill="url(#a)"/>
                        <path fill="#c8daea" d="M98 175c-3.888 0-3.227-1.468-4.568-5.17L82 132.207 170 80"/>
                        <path fill="#a9c9dd" d="M98 175c3 0 4.325-1.372 6-3l16-15.558-19.958-12.035"/>
                        <path fill="url(#b)" d="M100.04 144.41l48.36 35.729c5.519 3.045 9.501 1.468 10.876-5.123l19.685-92.763c2.015-8.08-3.08-11.746-8.36-9.349l-115.59 44.571c-7.89 3.165-7.843 7.567-1.438 9.528l29.663 9.259 68.673-43.325c3.242-1.966 6.218-.91 3.776 1.258"/>
                    </svg>
                    Telegram Forwarder
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="/dashboard">Dashboard</a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/logout">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'error' else 'danger' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Forwarding Status</h5>
                        <button id="refresh-status" class="btn btn-sm btn-outline-primary">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div id="status-container">
                            <div class="text-center py-4" id="status-loading">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading status...</p>
                            </div>
                            <div id="status-content" style="display: none;">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Progress:</span>
                                        <span id="progress-text">0/0</span>
                                    </div>
                                    <div class="progress position-relative">
                                        <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-label" id="progress-percent">0%</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="list-group">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Source:</span>
                                                <span id="source-name">-</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Destination:</span>
                                                <span id="destination-name">-</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Status:</span>
                                                <span id="status-text">Inactive</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-group">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Forwarded:</span>
                                                <span id="forwarded-count">0</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Duplicates:</span>
                                                <span id="duplicate-count">0</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Skipped:</span>
                                                <span id="skipped-count">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3" id="control-buttons">
                                    <button id="cancel-forwarding" class="btn btn-danger" style="display: none;">Cancel Forwarding</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Start New Forwarding</h5>
                    </div>
                    <div class="card-body">
                        <form id="forwarding-form">
                            <div class="mb-3">
                                <label for="source-select" class="form-label">Source</label>
                                <select class="form-select" id="source-select" required>
                                    <option value="" selected disabled>Select a source channel/group</option>
                                    <!-- Sources will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="destination-select" class="form-label">Destination</label>
                                <select class="form-select" id="destination-select" required>
                                    <option value="" selected disabled>Select a destination channel/group</option>
                                    <!-- Destinations will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="last-message-link" class="form-label">Last Message Link (Optional)</label>
                                <input type="text" class="form-control" id="last-message-link" placeholder="https://t.me/c/123456789/100">
                                <div class="form-text">If provided, forwarding will start after this message. Otherwise, all messages will be forwarded.</div>
                            </div>
                            <button type="submit" id="start-forwarding" class="btn btn-primary">Start Forwarding</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Add Source</h5>
                    </div>
                    <div class="card-body">
                        <form id="add-source-form">
                            <div class="mb-3">
                                <label for="source-link" class="form-label">Source Channel/Group Link</label>
                                <input type="text" class="form-control" id="source-link" placeholder="https://t.me/channel" required>
                                <div class="form-text">Enter the link to the Telegram channel or group you want to forward from.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Source</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Add Destination</h5>
                    </div>
                    <div class="card-body">
                        <form id="add-destination-form">
                            <div class="mb-3">
                                <label for="destination-link" class="form-label">Destination Channel/Group Link</label>
                                <input type="text" class="form-control" id="destination-link" placeholder="https://t.me/channel" required>
                                <div class="form-text">Enter the link to the Telegram channel or group you want to forward to. You must be an admin in this channel/group.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Destination</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Sources</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group" id="sources-list">
                            <li class="list-group-item text-center">No sources added yet</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Destinations</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group" id="destinations-list">
                            <li class="list-group-item text-center">No destinations added yet</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial status
            loadForwardingStatus();
            
            // Set up event listeners
            document.getElementById('refresh-status').addEventListener('click', loadForwardingStatus);
            document.getElementById('forwarding-form').addEventListener('submit', startForwarding);
            document.getElementById('add-source-form').addEventListener('submit', addSource);
            document.getElementById('add-destination-form').addEventListener('submit', addDestination);
            document.getElementById('cancel-forwarding').addEventListener('click', cancelForwarding);
            
            // Set up polling for status updates (every 5 seconds)
            setInterval(loadForwardingStatus, 5000);
        });
        
        function loadForwardingStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateStatusDisplay(data.status);
                    } else {
                        console.error('Error loading status:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }
        
        function updateStatusDisplay(status) {
            document.getElementById('status-loading').style.display = 'none';
            document.getElementById('status-content').style.display = 'block';
            
            // Update progress
            const progressPercent = status.total_messages > 0 ? Math.round((status.forwarded_messages / status.total_messages) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('progress-percent').textContent = `${progressPercent}%`;
            document.getElementById('progress-text').textContent = `${status.forwarded_messages}/${status.total_messages}`;
            
            // Update counters
            document.getElementById('source-name').textContent = status.source || '-';
            document.getElementById('destination-name').textContent = status.destination || '-';
            document.getElementById('status-text').textContent = status.active ? 'Active' : 'Inactive';
            document.getElementById('forwarded-count').textContent = status.forwarded_messages;
            document.getElementById('duplicate-count').textContent = status.duplicate_messages;
            document.getElementById('skipped-count').textContent = status.skipped_messages;
            
            // Show/hide cancel button
            document.getElementById('cancel-forwarding').style.display = status.active ? 'block' : 'none';
        }
        
        function startForwarding(event) {
            event.preventDefault();
            
            const sourceId = document.getElementById('source-select').value;
            const destinationId = document.getElementById('destination-select').value;
            const lastMessageLink = document.getElementById('last-message-link').value;
            
            if (!sourceId || !destinationId) {
                alert('Please select both source and destination');
                return;
            }
            
            const formData = new FormData();
            formData.append('source_id', sourceId);
            formData.append('destination_id', destinationId);
            if (lastMessageLink) {
                formData.append('last_message_link', lastMessageLink);
            }
            
            fetch('/start_forwarding', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Forwarding started successfully');
                    loadForwardingStatus();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error starting forwarding:', error);
                alert('Error starting forwarding');
            });
        }
        
        function addSource(event) {
            event.preventDefault();
            
            const sourceLink = document.getElementById('source-link').value;
            
            if (!sourceLink) {
                alert('Please enter a valid source link');
                return;
            }
            
            const formData = new FormData();
            formData.append('source_link', sourceLink);
            
            fetch('/add_source', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Source added successfully');
                    document.getElementById('source-link').value = '';
                    // You would typically refresh the sources list here
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error adding source:', error);
                alert('Error adding source');
            });
        }
        
        function addDestination(event) {
            event.preventDefault();
            
            const destinationLink = document.getElementById('destination-link').value;
            
            if (!destinationLink) {
                alert('Please enter a valid destination link');
                return;
            }
            
            const formData = new FormData();
            formData.append('destination_link', destinationLink);
            
            fetch('/add_destination', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Destination added successfully');
                    document.getElementById('destination-link').value = '';
                    // You would typically refresh the destinations list here
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error adding destination:', error);
                alert('Error adding destination');
            });
        }
        
        function cancelForwarding() {
            if (!confirm('Are you sure you want to cancel the forwarding process?')) {
                return;
            }
            
            fetch('/cancel_forwarding', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Forwarding cancelled successfully');
                    loadForwardingStatus();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error cancelling forwarding:', error);
                alert('Error cancelling forwarding');
            });
        }
    </script>
</body>
</html>